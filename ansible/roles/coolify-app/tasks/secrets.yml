---
# Retrieve secrets from Bitwarden Secrets Manager
- name: Validate BWS_ACCESS_TOKEN environment variable is set
  ansible.builtin.fail:
    msg: "BWS_ACCESS_TOKEN environment variable must be set to access Bitwarden Secrets Manager"
  when: lookup('env', 'BWS_ACCESS_TOKEN') == ''

- name: Retrieve Telegram bot token from Bitwarden
  ansible.builtin.set_fact:
    telegram_bot_token: "{{ lookup('community.general.bitwarden_secrets_manager', 'TELEGRAM_BOT_TOKEN') }}"
  no_log: true

- name: Retrieve Anthropic API key from Bitwarden
  ansible.builtin.set_fact:
    anthropic_api_key: "{{ lookup('community.general.bitwarden_secrets_manager', 'ANTHROPIC_API_KEY') }}"
  no_log: true

- name: Retrieve Clawdbot gateway token from Bitwarden
  ansible.builtin.set_fact:
    clawdbot_gateway_token: "{{ lookup('community.general.bitwarden_secrets_manager', 'CLAWDBOT_GATEWAY_TOKEN') }}"
  no_log: true

- name: Retrieve Allen's Telegram ID from Bitwarden
  ansible.builtin.set_fact:
    allen_telegram_id: "{{ lookup('community.general.bitwarden_secrets_manager', 'ALLEN_TELEGRAM_ID') }}"
  no_log: true

- name: Retrieve Kim's Telegram ID from Bitwarden
  ansible.builtin.set_fact:
    kim_telegram_id: "{{ lookup('community.general.bitwarden_secrets_manager', 'KIM_TELEGRAM_ID') }}"
  no_log: true

- name: Retrieve Sue's Telegram ID from Bitwarden
  ansible.builtin.set_fact:
    sue_telegram_id: "{{ lookup('community.general.bitwarden_secrets_manager', 'SUE_TELEGRAM_ID') }}"
  no_log: true

- name: Validate all required secrets were retrieved
  ansible.builtin.assert:
    that:
      - telegram_bot_token is defined
      - anthropic_api_key is defined
      - clawdbot_gateway_token is defined
      - allen_telegram_id is defined
      - kim_telegram_id is defined
      - sue_telegram_id is defined
    fail_msg: "One or more required secrets could not be retrieved from Bitwarden Secrets Manager"
    quiet: true

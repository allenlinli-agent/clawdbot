---
# Retrieve secrets from Bitwarden Secrets Manager
- name: Validate BWS_ACCESS_TOKEN environment variable is set
  ansible.builtin.fail:
    msg: "BWS_ACCESS_TOKEN environment variable must be set to access Bitwarden Secrets Manager"
  when: lookup('env', 'BWS_ACCESS_TOKEN') == ''

- name: Retrieve Telegram bot token from Bitwarden
  ansible.builtin.set_fact:
    telegram_bot_token: "{{ lookup('community.general.bitwarden_secrets_manager', '57f05e98-60d1-4c87-b286-b3d5002bc42a') }}"
  no_log: true

- name: Retrieve Anthropic API key from Bitwarden
  ansible.builtin.set_fact:
    anthropic_api_key: "{{ lookup('community.general.bitwarden_secrets_manager', '9d878a10-c128-4f0d-b136-b3d5002bd0f5') }}"
  no_log: true

- name: Retrieve Clawdbot gateway token from Bitwarden
  ansible.builtin.set_fact:
    clawdbot_gateway_token: "{{ lookup('community.general.bitwarden_secrets_manager', '1ef49f11-1ac3-4e87-a748-b3d5002bdaba') }}"
  no_log: true

- name: Retrieve Allen's Telegram ID from Bitwarden
  ansible.builtin.set_fact:
    allen_telegram_id: "{{ lookup('community.general.bitwarden_secrets_manager', 'b4891223-dfbc-48b3-97b2-b3d5002be127') }}"
  no_log: true

- name: Retrieve Kim's Telegram ID from Bitwarden
  ansible.builtin.set_fact:
    kim_telegram_id: "{{ lookup('community.general.bitwarden_secrets_manager', '6ae190a1-fbab-475a-8303-b3d5002bebcc') }}"
  no_log: true

- name: Retrieve Sue's Telegram ID from Bitwarden
  ansible.builtin.set_fact:
    sue_telegram_id: "{{ lookup('community.general.bitwarden_secrets_manager', 'ec05f689-df82-4e6f-8029-b3d5002bf30d') }}"
  no_log: true

- name: Validate all required secrets were retrieved
  ansible.builtin.assert:
    that:
      - telegram_bot_token is defined
      - anthropic_api_key is defined
      - clawdbot_gateway_token is defined
      - allen_telegram_id is defined
      - kim_telegram_id is defined
      - sue_telegram_id is defined
    fail_msg: "One or more required secrets could not be retrieved from Bitwarden Secrets Manager"
    quiet: true
